
-- ==============================================================================
-- RUN THIS SCRIPT IN YOUR SUPABASE SQL EDITOR TO FIX PERMISSION ERRORS
-- ==============================================================================

-- 1. CLUBS TABLES (If not already created)
CREATE TABLE IF NOT EXISTS public.clubs (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT,
  description TEXT,
  meeting_day TEXT,
  member_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

CREATE TABLE IF NOT EXISTS public.club_members (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  club_id UUID REFERENCES public.clubs(id) ON DELETE CASCADE,
  student_id UUID REFERENCES public.students(id) ON DELETE CASCADE,
  role TEXT DEFAULT 'member',
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
  UNIQUE(club_id, student_id)
);

-- 2. ENABLE ROW LEVEL SECURITY (RLS) ON KEY TABLES
ALTER TABLE public.teacher_allocations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.clubs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.club_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.streams ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.class_levels ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.academic_years ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.terms ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.school_events ENABLE ROW LEVEL SECURITY;

-- 3. POLICIES FOR TEACHER ALLOCATIONS
DROP POLICY IF EXISTS "Admins full access allocations" ON public.teacher_allocations;
DROP POLICY IF EXISTS "Teachers view own allocations" ON public.teacher_allocations;

CREATE POLICY "Admins full access allocations" ON public.teacher_allocations
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );

CREATE POLICY "Teachers view own allocations" ON public.teacher_allocations
  FOR SELECT USING (
    teacher_id = auth.uid()
  );

-- 4. POLICIES FOR STUDENTS
DROP POLICY IF EXISTS "Admins full access students" ON public.students;
DROP POLICY IF EXISTS "Teachers view students" ON public.students;

CREATE POLICY "Admins full access students" ON public.students
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );

CREATE POLICY "Teachers view students" ON public.students
  FOR SELECT USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'teacher')
  );

-- 5. POLICIES FOR CLUBS & MEMBERS
DROP POLICY IF EXISTS "Admins full access clubs" ON public.clubs;
DROP POLICY IF EXISTS "Everyone views clubs" ON public.clubs;

CREATE POLICY "Admins full access clubs" ON public.clubs
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );

CREATE POLICY "Everyone views clubs" ON public.clubs
  FOR SELECT USING (true);

CREATE POLICY "Admins manage club members" ON public.club_members
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );

-- 6. POLICIES FOR ACADEMIC STRUCTURE (Streams, Classes, Subjects)
DROP POLICY IF EXISTS "Admins manage streams" ON public.streams;
CREATE POLICY "Admins manage streams" ON public.streams
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );

CREATE POLICY "Everyone reads streams" ON public.streams FOR SELECT USING (true);
CREATE POLICY "Everyone reads classes" ON public.class_levels FOR SELECT USING (true);
CREATE POLICY "Everyone reads subjects" ON public.subjects FOR SELECT USING (true);
CREATE POLICY "Everyone reads years" ON public.academic_years FOR SELECT USING (true);
CREATE POLICY "Everyone reads terms" ON public.terms FOR SELECT USING (true);

-- Allow admins to manage Years and Terms
CREATE POLICY "Admins manage years" ON public.academic_years
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );
  
CREATE POLICY "Admins manage terms" ON public.terms
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and role = 'admin')
  );


-- 7. PROFILE POLICIES (Fixes infinite loading on login)
CREATE POLICY "Public profiles view" ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users update own profile" ON public.profiles FOR UPDATE USING (id = auth.uid());
CREATE POLICY "Users insert own profile" ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- 8. FIX MISSING STREAMS FOR S1-S4
DO $$
DECLARE
  level_rec RECORD;
  stream_name TEXT;
  stream_arr TEXT[] := ARRAY['North', 'Central', 'South', 'East', 'West'];
BEGIN
  FOR level_rec IN SELECT id, name FROM public.class_levels WHERE level BETWEEN 1 AND 4 LOOP
    FOREACH stream_name IN ARRAY stream_arr LOOP
      IF NOT EXISTS (SELECT 1 FROM public.streams WHERE class_id = level_rec.id AND name = stream_name) THEN
         INSERT INTO public.streams (class_id, name) VALUES (level_rec.id, stream_name);
      END IF;
    END LOOP;
  END LOOP;
END $$;

-- 9. SEED MISSING SUBJECTS
DO $$
DECLARE
  subj_name TEXT;
  subj_arr TEXT[] := ARRAY[
    'Biology', 'Physics', 'Chemistry', 'ICT', 'Mathematics', 'English', 
    'Geography', 'Kiswahili', 'Fine Art', 'CRE', 'Luganda', 
    'Entrepreneurship', 'Performing Arts', 'Moral Training', 'History', 
    'Agriculture', 'Physical Education', 'Literature', 'Economics'
  ];
BEGIN
  FOREACH subj_name IN ARRAY subj_arr LOOP
    IF NOT EXISTS (SELECT 1 FROM public.subjects WHERE name = subj_name) THEN
      INSERT INTO public.subjects (name, code, level) 
      VALUES (subj_name, UPPER(SUBSTRING(subj_name, 1, 3)), 'O-Level');
    END IF;
  END LOOP;
END $$;

-- 10. CLUBS FIX
ALTER TABLE public.clubs ADD COLUMN IF NOT EXISTS category TEXT DEFAULT 'General';
ALTER TABLE public.clubs ADD COLUMN IF NOT EXISTS meeting_day TEXT DEFAULT 'Friday';

-- 11. (OPTIONAL) SINGLE ACTIVE YEAR TRIGGER
-- Run this if you want the DB to enforce only 1 active year automatically.
-- NOTE: The frontend already handles this logic safely, so this is optional but recommended.
CREATE OR REPLACE FUNCTION set_single_current_year()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_current = true THEN
    UPDATE public.academic_years SET is_current = false WHERE id <> NEW.id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_single_current_year ON public.academic_years;
CREATE TRIGGER trigger_single_current_year
  BEFORE INSERT OR UPDATE ON public.academic_years
  FOR EACH ROW
  WHEN (NEW.is_current = true)
  EXECUTE PROCEDURE set_single_current_year();

-- 12. UPDATE ROLE CHECK CONSTRAINT FOR 'EDITOR'
-- This allows the profile table to accept 'editor' as a valid role
DO $$
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'profiles_role_check') THEN
    ALTER TABLE public.profiles DROP CONSTRAINT profiles_role_check;
  END IF;
END $$;

ALTER TABLE public.profiles ADD CONSTRAINT profiles_role_check 
  CHECK (role IN ('admin', 'teacher', 'student', 'parent', 'alumni', 'editor'));

-- 13. SCHOOL EVENTS PERMISSIONS
-- Admins and Editors can manage events
DROP POLICY IF EXISTS "Manage events" ON public.school_events;
CREATE POLICY "Manage events" ON public.school_events
  FOR ALL USING (
    exists (select 1 from public.profiles where id = auth.uid() and (role = 'admin' OR role = 'editor'))
  );

DROP POLICY IF EXISTS "Read events" ON public.school_events;
CREATE POLICY "Read events" ON public.school_events
  FOR SELECT USING (true);
